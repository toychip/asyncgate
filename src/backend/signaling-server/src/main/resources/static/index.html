<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Kurento SFU</title>
</head>
<body>
<h1>WebRTC SFU ì±„íŒ…ë°©</h1>

<!-- ì‚¬ìš©ì ì…ë ¥ í•„ë“œ -->
<label>Room ID:</label>
<input type="text" id="roomIdInput" placeholder="Room ID ì…ë ¥">
<input type="text" id="tokenInput" placeholder="Access Token ì…ë ¥">
<button onclick="joinRoom()">ë°© ì°¸ê°€</button>

<br><br>

<!-- ë¯¸ë””ì–´ ì œì–´ ë²„íŠ¼ -->
<button id="audioBtn" onclick="toggleAudio()">ğŸ™ï¸ ìŒì„± ê³µìœ </button>
<button id="videoBtn" onclick="toggleVideo()">ğŸ“¹ í™”ìƒ ê³µìœ </button>
<button id="screenBtn" onclick="toggleScreenShare()">ğŸ–¥ï¸ í™”ë©´ ê³µìœ </button>

<br><br>

<h3>ğŸ“¹ ë‚´ ì¹´ë©”ë¼</h3>
<video id="localVideo" autoplay muted></video>

<h3>ğŸ–¥ï¸ ë‚´ í™”ë©´ ê³µìœ </h3>
<video id="screenShareVideo" autoplay></video>

<h3>ğŸ“º ìƒëŒ€ë°© ì˜ìƒ</h3>
<div id="remoteVideos"></div>

<script>
    // API ë° WebSocket ê¸°ë³¸ ì„¤ì •
    const apiBaseUrl = "http://localhost:8600/room"; // Spring Boot API URL
    let ws;
    let peerConnection;
    let roomId;
    let userId;
    let localStream = null;
    let screenStream = null;
    let isAudioEnabled = false;
    let isVideoEnabled = false;
    let isScreenSharing = false;
    let remoteUsers = {}; // ìƒëŒ€ë°© ì •ë³´ ì €ì¥

    async function joinRoom() {
        roomId = document.getElementById("roomIdInput").value;
        const token = document.getElementById("tokenInput").value;

        if (!roomId || !token) {
            alert("Room IDì™€ Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const response = await fetch(`${apiBaseUrl}/${roomId}/join`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }
        });

        if (response.ok) {
            alert("ë°© ì°¸ê°€ ì™„ë£Œ!");
            userId = "user-" + Math.floor(Math.random() * 1000);
            startWebRTC();
        } else {
            alert("ë°© ì°¸ê°€ ì‹¤íŒ¨");
        }
    }

    function startWebRTC() {
        ws = new WebSocket("ws://localhost:8600/signal");

        ws.onopen = () => {
            console.log("âœ… WebSocket ì—°ê²°ë¨");
            startCall();
        };

        ws.onmessage = async (message) => {
            const data = JSON.parse(message.data);

            if (data.id === "sdpAnswer") {
                await peerConnection.setRemoteDescription(new RTCSessionDescription({
                    type: "answer",
                    sdp: data.sdpAnswer
                }));
            } else if (data.id === "iceCandidate") {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } else if (data.id === "mediaStateUpdate") {
                updateUserMediaState(data.userId, data.mediaType, data.enabled);
            }
        };
    }

    async function startCall() {
        peerConnection = new RTCPeerConnection({
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                {
                    urls: "turn:turn.yourdomain.com:3478",
                    username: "your_username",
                    credential: "your_password"
                }
            ]
        });

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                ws.send(JSON.stringify({
                    id: "iceCandidate",
                    roomId: roomId,
                    userId: userId,
                    candidate: event.candidate
                }));
            }
        };

        peerConnection.ontrack = (event) => {
            const remoteUserId = event.streams[0].id; // ì‚¬ìš©ì IDë¥¼ ìŠ¤íŠ¸ë¦¼ IDë¡œ ê°€ì •
            if (!remoteUsers[remoteUserId]) {
                remoteUsers[remoteUserId] = { video: false, audio: false, screen: false };

                const userContainer = document.createElement("div");
                userContainer.id = `user-${remoteUserId}`;
                userContainer.innerHTML = `
                    <h4>ğŸ§‘â€ğŸ’» ${remoteUserId}</h4>
                    <video id="video-${remoteUserId}" autoplay playsinline></video>
                    <p>
                        ğŸ¤ ìŒì„±: <span id="audio-status-${remoteUserId}">âŒ</span> |
                        ğŸ“¹ í™”ìƒ: <span id="video-status-${remoteUserId}">âŒ</span> |
                        ğŸ–¥ï¸ í™”ë©´ ê³µìœ : <span id="screen-status-${remoteUserId}">âŒ</span>
                    </p>
                `;
                document.getElementById("remoteVideos").appendChild(userContainer);
            }
            document.getElementById(`video-${remoteUserId}`).srcObject = event.streams[0];
        };

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        document.getElementById("localVideo").srcObject = localStream;
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        ws.send(JSON.stringify({
            id: "start",
            roomId: roomId,
            userId: userId,
            sdpOffer: offer.sdp
        }));
    }

    function updateUserMediaState(userId, mediaType, enabled) {
        remoteUsers[userId][mediaType] = enabled;
        document.getElementById(`${mediaType}-status-${userId}`).innerText = enabled ? "âœ…" : "âŒ";
    }

    async function toggleAudio() {
        if (!localStream) return;
        isAudioEnabled = !isAudioEnabled;
        localStream.getAudioTracks().forEach(track => track.enabled = isAudioEnabled);
        document.getElementById("audioBtn").innerText = isAudioEnabled ? "ğŸ”‡ ìŒì†Œê±°" : "ğŸ™ï¸ ìŒì„± ê³µìœ ";
        ws.send(JSON.stringify({ id: "mediaStateUpdate", roomId, userId, mediaType: "audio", enabled: isAudioEnabled }));
    }

    async function toggleVideo() {
        if (!localStream) return;
        isVideoEnabled = !isVideoEnabled;
        localStream.getVideoTracks().forEach(track => track.enabled = isVideoEnabled);
        document.getElementById("videoBtn").innerText = isVideoEnabled ? "ğŸ“· ë¹„ë””ì˜¤ ë„ê¸°" : "ğŸ“¹ í™”ìƒ ê³µìœ ";
        ws.send(JSON.stringify({ id: "mediaStateUpdate", roomId, userId, mediaType: "video", enabled: isVideoEnabled }));
    }

    async function toggleScreenShare() {
        if (isScreenSharing) {
            stopScreenShare();
            document.getElementById("screenBtn").innerText = "ğŸ–¥ï¸ í™”ë©´ ê³µìœ ";
        } else {
            screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            document.getElementById("screenShareVideo").srcObject = screenStream;
            screenStream.getTracks().forEach(track => peerConnection.addTrack(track, screenStream));
            screenStream.getTracks()[0].onended = () => stopScreenShare();
            document.getElementById("screenBtn").innerText = "ğŸ“´ í™”ë©´ ê³µìœ  ì¤‘ì§€";
            ws.send(JSON.stringify({ id: "mediaStateUpdate", roomId, userId, mediaType: "screen", enabled: true }));
        }
        isScreenSharing = !isScreenSharing;
    }
</script>
</body>
</html>